<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <title>Scan สลิป: เลือกกรอบ → OCR → รวมยอด (Enhanced)</title>
    <style>
      body {
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto,
          "Noto Sans", "Helvetica Neue", Arial;
        margin: 18px;
        background: #f5f6fa;
        color: #1e1e2f;
      }

      h1 {
        margin-bottom: 20px;
        font-size: 24px;
        font-weight: 700;
        color: #2f2f41;
      }

      /* ===== Progress Bar ===== */
      .progress-container {
        margin: 20px 0;
        padding: 16px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        display: none;
      }

      .progress {
        height: 12px;
        border-radius: 6px;
        overflow: hidden;
        background: #e5e7eb;
        position: relative;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(45deg, #4f46e5, #7c3aed);
        transition: width 0.3s ease;
        border-radius: 6px;
      }

      .progress-text {
        margin-top: 8px;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
        color: #4b5563;
      }

      /* ===== Error Messages ===== */
      .error-message {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
        padding: 12px 16px;
        border-radius: 8px;
        margin: 10px 0;
        display: none;
      }

      .success-message {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        color: #16a34a;
        padding: 12px 16px;
        border-radius: 8px;
        margin: 10px 0;
        display: none;
      }

      /* ===== Loading Spinner ===== */
      .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f4f6;
        border-top: 2px solid #4f46e5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* ===== Status Indicators ===== */
      .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        margin-left: 8px;
      }

      .status-badge.processing {
        background: #fef3c7;
        color: #92400e;
      }

      .status-badge.completed {
        background: #dcfce7;
        color: #166534;
      }

      .status-badge.error {
        background: #fef2f2;
        color: #dc2626;
      }

      .status-badge.skipped {
        background: #f3f4f6;
        color: #6b7280;
      }

      /* ===== Topbar ===== */
      .topbar {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        background: #ffffff;
        padding: 16px 20px;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        align-items: center;
      }

      .topbar .controls,
      .topbar .input-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 12px;
        align-items: center;
      }

      .topbar label {
        font-size: 14px;
        color: #555;
      }

      .topbar input[type="number"],
      .topbar select,
      .topbar input[type="file"] {
        padding: 6px 10px;
        font-size: 14px;
        border: 1px solid #ddd;
        border-radius: 10px;
        background: #fafafa;
        min-width: 60px;
        transition: border 0.2s, box-shadow 0.2s;
      }

      .topbar input[type="number"]:focus,
      .topbar select:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
      }

      button {
        padding: 8px 14px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        position: relative;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      }

      button.primary {
        background: #4f46e5;
        color: white;
      }
      button.primary-2 {
        background: #10b981;
        color: white;
      }
      button.primary-3 {
        background: #ef4444;
        color: white;
      }
      button.secondary {
        background: #f3f4f6;
        color: #555;
      }

      button.danger {
        background: #dc2626;
        color: white;
      }

      /* ===== Card ===== */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        margin-top: 20px;
      }

      .card {
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
      }

      .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      }

      .card.processing {
        border: 2px solid #fbbf24;
        background: #fffbeb;
      }

      .card.completed {
        border: 2px solid #10b981;
      }

      .card.error {
        border: 2px solid #ef4444;
        background: #fef2f2;
      }

      .card canvas {
        width: 100%;
        height: auto;
        display: block;
        border-bottom: 1px solid #eee;
        cursor: crosshair;
      }

      .card .meta {
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
      }

      .card .meta .actions button {
        margin-right: 6px;
        margin-top: 4px;
        font-size: 13px;
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid #ddd;
        background: #f3f4f6;
        color: #333;
      }

      .card .meta .actions button:hover:not(:disabled) {
        background: #e5e7eb;
      }

      .card .info {
        padding: 0 16px 12px;
        font-size: 13px;
        color: #555;
      }

      .card .info div {
        margin-top: 6px;
      }

      .results {
        margin-top: 24px;
        background: #ffffff;
        padding: 16px;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
      }

      .results .row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px dashed #eee;
      }

      .results .row:last-child {
        border-bottom: none;
      }

      #perSlipList .list-group-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: none;
        padding: 10px 0;
      }
      
      #perSlipList .list-group-item:not(:last-child) {
        border-bottom: 1px dashed #ddd;
      }

      /* ===== Responsive ===== */
      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }
        
        .topbar {
          padding: 12px;
        }
        
        .topbar .controls {
          width: 100%;
          justify-content: center;
        }
        
        body {
          margin: 12px;
        }
      }
    </style>
  </head>
  <body>
    <h1>สแกนตัวเลขจากสลิป - Enhanced Version</h1>

    <div class="topbar">
        <label for="bankSelect" style="color: #ef4444">**เลือกธนาคาร**</label>
        <select id="bankSelect">
          <option value="">-- เลือก --</option>
          <option value="SCB" style="background-color: purple; color: white">SCB</option>
          <option value="Krungthai" style="background-color: skyblue; color: white">Krungthai</option>
          <option value="Bangkok" style="background-color: blue; color: white">Bangkok</option>
          <option value="TTB" style="background-color: orange; color: white">TTB</option>
          <option value="KPLUS" style="background-color: rgb(0, 255, 0); color: white">KPLUS</option>
        </select>
        
        <input id="inputFiles" type="file" accept="image/*" multiple />
        
        <div class="controls">
          <button id="btnSuggested">ใช้ตำแหน่งแนะนำ</button>
          <button id="btnScanAll" class="primary">สแกนทั้งหมด (OCR)</button>
          <button id="btnStopScan" class="danger" style="display: none;">หยุดการสแกน</button>
          <button id="btnClear" class="primary-2">เริ่มใหม่</button>
          <button id="toggleDrag" class="primary-3">ปิดการลาก</button>
        </div>

        <!-- พิกัดตัวเลข -->
        <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
          <label>x-start:</label>
          <input type="number" id="inputRx" value="0.65" step="0.01" min="0" max="1" />
          <label>y-start:</label>
          <input type="number" id="inputRy" value="0.58" step="0.01" min="0" max="1" />
          <label>width:</label>
          <input type="number" id="inputRw" value="0.3" step="0.01" min="0" max="1" />
          <label>height:</label>
          <input type="number" id="inputRh" value="0.08" step="0.01" min="0" max="1" />
        </div>

        <!-- พิกัดชื่อ -->
        <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
          <label>ชื่อ x:</label>
          <input type="number" id="inputRxName" value="0.54" step="0.01" min="0" max="1" />
          <label>ชื่อ y:</label>
          <input type="number" id="inputRyName" value="0.32" step="0.01" min="0" max="1" />
          <label>ชื่อ w:</label>
          <input type="number" id="inputRwName" value="0.45" step="0.01" min="0" max="1" />
          <label>ชื่อ h:</label>
          <input type="number" id="inputRhName" value="0.08" step="0.01" min="0" max="1" />
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container" id="progressContainer">
      <div class="progress">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
      <div class="progress-text" id="progressText">กำลังเตรียมการ...</div>
    </div>

    <!-- Messages -->
    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>

    <div id="status" class="hint">
      อัปโหลดรูปสลิปหลายไฟล์ แล้วลากกรอบสีบนรูปเพื่อเลือกพื้นที่ OCR
    </div>

    <div id="cards" class="grid"></div>

    <div class="card mt-4 shadow-sm" id="resultsPanel" style="display: none">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h5 class="card-title mb-0">สรุปผล</h5>
            <small class="text-muted">สลิปทั้งหมด: <span id="totalCount">0</span> ใบ</small>
          </div>
          <div class="text-end">
            <small class="text-muted">ยอดรวมทั้งหมด</small>
            <div class="fs-3 fw-bold text-success">฿ <span id="grandTotal">0.00</span></div>
          </div>
        </div>
        <ul class="list-group list-group-flush" id="perSlipList"></ul>
      </div>
    </div>

    <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script>
      // Global variables
      const input = document.getElementById("inputFiles");
      const cards = document.getElementById("cards");
      const btnScanAll = document.getElementById("btnScanAll");
      const btnStopScan = document.getElementById("btnStopScan");
      const btnSuggested = document.getElementById("btnSuggested");
      const btnClear = document.getElementById("btnClear");
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      const errorMessage = document.getElementById("errorMessage");
      const successMessage = document.getElementById("successMessage");

      let slips = [];
      let dragEnabled = false;
      let isScanning = false;
      let scanController = null;

      // Utility functions
      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = "block";
        successMessage.style.display = "none";
        setTimeout(() => {
          errorMessage.style.display = "none";
        }, 5000);
      }

      function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.style.display = "block";
        errorMessage.style.display = "none";
        setTimeout(() => {
          successMessage.style.display = "none";
        }, 3000);
      }

      function updateProgress(current, total, message) {
        const percentage = Math.round((current / total) * 100);
        progressBar.style.width = `${percentage}%`;
        progressText.textContent = `${message} (${current}/${total})`;
      }

      function showProgress() {
        progressContainer.style.display = "block";
      }

      function hideProgress() {
        progressContainer.style.display = "none";
        progressBar.style.width = "0%";
      }

      // Validation functions
      function validateFile(file) {
        const maxSize = 10 * 1024 * 1024; // 10MB
        const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
        
        if (file.size > maxSize) {
          throw new Error(`ไฟล์ "${file.name}" ใหญ่เกิน 10MB`);
        }
        
        if (!allowedTypes.includes(file.type)) {
          throw new Error(`ไฟล์ "${file.name}" ไม่ใช่รูปภาพที่รองรับ`);
        }
      }

      function validateImageDimensions(img, file) {
        if (img.naturalWidth < 100 || img.naturalHeight < 100) {
          throw new Error(`รูป "${file.name}" มีขนาดเล็กเกินไป`);
        }
        
        if (img.naturalWidth > 5000 || img.naturalHeight > 5000) {
          console.warn(`รูป "${file.name}" มีขนาดใหญ่มาก อาจประมวลผลช้า`);
        }
      }

      // Enhanced file handling with error checking
      input.addEventListener("change", async (e) => {
        const bank = document.getElementById("bankSelect").value;
        if (!bank) {
          showError("กรุณาเลือกธนาคารก่อนอัปโหลดรูปสลิป");
          input.value = "";
          return;
        }

        const files = Array.from(e.target.files);
        if (!files.length) return;

        try {
          // Validate all files first
          files.forEach(validateFile);
          
          showProgress();
          updateProgress(0, files.length, "กำลังโหลดรูปภาพ");
          
          slips = [];
          cards.innerHTML = "";
          document.getElementById("resultsPanel").style.display = "none";

          for (let i = 0; i < files.length; i++) {
            const f = files[i];
            updateProgress(i + 1, files.length, `โหลด ${f.name}`);
            
            try {
              const url = URL.createObjectURL(f);
              const img = new Image();
              
              await new Promise((resolve, reject) => {
                img.onload = () => {
                  try {
                    validateImageDimensions(img, f);
                    resolve();
                  } catch (err) {
                    reject(err);
                  }
                };
                img.onerror = () => reject(new Error(`ไม่สามารถโหลดรูป "${f.name}" ได้`));
                img.src = url;
              });
              
              createCardForImage(f, img);
              
            } catch (err) {
              console.error(`Error loading ${f.name}:`, err);
              showError(err.message);
            }
          }
          
          hideProgress();
          showSuccess(`โหลดรูปสำเร็จ ${slips.length} ใบ`);
          
        } catch (err) {
          hideProgress();
          showError(err.message);
          input.value = "";
        }
      });

      function createCardForImage(file, img) {
        const card = document.createElement("div");
        card.className = "card";

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.style.width = "100%";
        canvas.style.height = "auto";

        const wrapper = document.createElement("div");
        wrapper.style.position = "relative";
        wrapper.appendChild(canvas);
        card.appendChild(wrapper);

        // Close button
        const btnClose = document.createElement("button");
        btnClose.innerHTML = "×";
        btnClose.style.position = "absolute";
        btnClose.style.top = "5px";
        btnClose.style.right = "5px";
        btnClose.style.backgroundColor = "#ef4444";
        btnClose.style.color = "white";
        btnClose.style.border = "none";
        btnClose.style.borderRadius = "50%";
        btnClose.style.width = "32px";
        btnClose.style.height = "32px";
        btnClose.style.cursor = "pointer";
        btnClose.style.fontSize = "18px";
        btnClose.style.display = "flex";
        btnClose.style.alignItems = "center";
        btnClose.style.justifyContent = "center";
        btnClose.style.zIndex = "9999";
        wrapper.appendChild(btnClose);

        // Overlay container
        const overlayContainer = document.createElement("canvas");
        overlayContainer.width = canvas.width;
        overlayContainer.height = canvas.height;
        overlayContainer.style.width = "100%";
        overlayContainer.style.height = "auto";
        overlayContainer.style.position = "absolute";
        overlayContainer.style.top = "0";
        overlayContainer.style.left = "0";
        overlayContainer.style.pointerEvents = "none";
        overlayContainer.style.zIndex = "999";
        card.appendChild(overlayContainer);

        // Meta information
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `
          <div class="small">
            <strong>${file.name}</strong>
            <span class="status-badge" id="statusBadge">รอการสแกน</span>
            <div class="small">ขนาด: ${canvas.width}×${canvas.height}</div>
          </div>`;

        const actions = document.createElement("div");
        actions.className = "actions";

        const btnUseSuggested = document.createElement("button");
        btnUseSuggested.textContent = "ตำแหน่งแนะนำ";

        const btnOCR = document.createElement("button");
        btnOCR.textContent = "OCR ใบนี้";

        const btnResetRect = document.createElement("button");
        btnResetRect.textContent = "ล้างกรอบ";

        const btnEditNumber = document.createElement("button");
        btnEditNumber.textContent = "แก้ไขตัวเลข";

        actions.appendChild(btnUseSuggested);
        actions.appendChild(btnOCR);
        actions.appendChild(btnResetRect);
        actions.appendChild(btnEditNumber);
        meta.appendChild(actions);
        card.appendChild(meta);

        const outName = document.createElement("div");
        outName.className = "small";
        outName.style.marginTop = "8px";
        outName.innerHTML = `ชื่อผู้โอน: <span id="ocrNameText">-</span>`;
        card.appendChild(outName);

        const info = document.createElement("div");
        info.className = "small";
        info.style.marginTop = "8px";
        info.innerHTML = `กรอบที่เลือก: <span id="rectInfo">ยังไม่เลือก</span>`;
        card.appendChild(info);

        const out = document.createElement("div");
        out.className = "small";
        out.style.marginTop = "8px";
        out.innerHTML = `ผล OCR: <span id="ocrText">-</span>`;
        card.appendChild(out);

        cards.appendChild(card);

        const slip = {
          file,
          img,
          canvas,
          ctx,
          selRect: null,
          selRectName: null,
          ocrText: null,
          ocrName: null,
          number: null,
          status: 'pending', // pending, processing, completed, error, skipped
          elements: {
            card,
            overlayContainer,
            rectInfo: info.querySelector("#rectInfo"),
            ocrTextElem: out.querySelector("#ocrText"),
            ocrNameElem: outName.querySelector("#ocrNameText"),
            statusBadge: meta.querySelector("#statusBadge"),
            btnOCR,
            btnUseSuggested,
            btnResetRect,
            btnEditNumber,
            btnClose
          },
        };
        slips.push(slip);

        // Event handlers
        btnClose.addEventListener("click", () => {
          const idx = slips.indexOf(slip);
          if (idx > -1) slips.splice(idx, 1);
          card.remove();
          refreshSummary();
        });

        btnEditNumber.addEventListener("click", () => {
          const val = prompt("กรอกตัวเลขใหม่:", slip.number ?? "");
          if (val !== null) {
            const num = parseFloat(val.replace(/,/g, ""));
            if (!isNaN(num)) {
              slip.number = num;
              slip.elements.ocrTextElem.textContent = `แก้ไข: ${num.toFixed(2)}`;
              refreshSummary();
            } else {
              showError("กรอกตัวเลขไม่ถูกต้อง");
            }
          }
        });

        btnUseSuggested.addEventListener("click", () => {
          const inputRx = document.getElementById("inputRx");
          const inputRy = document.getElementById("inputRy");
          const inputRw = document.getElementById("inputRw");
          const inputRh = document.getElementById("inputRh");
          const inputRxName = document.getElementById("inputRxName");
          const inputRyName = document.getElementById("inputRyName");
          const inputRwName = document.getElementById("inputRwName");
          const inputRhName = document.getElementById("inputRhName");

          slip.selRect = {
            x: Math.round(parseFloat(inputRx.value) * slip.canvas.width),
            y: Math.round(parseFloat(inputRy.value) * slip.canvas.height),
            w: Math.round(parseFloat(inputRw.value) * slip.canvas.width),
            h: Math.round(parseFloat(inputRh.value) * slip.canvas.height)
          };

          slip.selRectName = {
            x: Math.round(parseFloat(inputRxName.value) * slip.canvas.width),
            y: Math.round(parseFloat(inputRyName.value) * slip.canvas.height),
            w: Math.round(parseFloat(inputRwName.value) * slip.canvas.width),
            h: Math.round(parseFloat(inputRhName.value) * slip.canvas.height)
          };

          slip.elements.rectInfo.textContent = `(แนะนำ) x:${slip.selRect.x} y:${slip.selRect.y} w:${slip.selRect.w} h:${slip.selRect.h}`;
          redrawCanvasWithRect(slip);
        });

        btnResetRect.addEventListener("click", () => {
          resetSlip(slip);
          redrawCanvasWithRect(slip);
        });

        btnOCR.addEventListener("click", async () => {
          try {
            await processSlipOCR(slip);
            refreshSummary();
          } catch (err) {
            showError(`Error OCR ใบ ${slip.file.name}: ${err.message}`);
          }
        });

        redrawCanvasWithRect(slip);
        enableRectSelection(wrapper, canvas, slip);
      }

      function resetSlip(slip) {
        slip.selRect = null;
        slip.selRectName = null;
        slip.ocrText = null;
        slip.ocrName = null;
        slip.number = null;
        slip.status = 'pending';

        slip.elements.ocrTextElem.textContent = "-";
        slip.elements.ocrTextElem.style.color = "";
        slip.elements.ocrNameElem.textContent = "-";
        slip.elements.statusBadge.textContent = "รอการสแกน";
        slip.elements.statusBadge.className = "status-badge";
        slip.elements.btnOCR.disabled = false;
        slip.elements.btnEditNumber.disabled = false;
        slip.elements.card.className = "card";
        slip.elements.rectInfo.textContent = "ยังไม่เลือก";
      }

      function setSlipStatus(slip, status, message = '') {
        slip.status = status;
        
        const badge = slip.elements.statusBadge;
        const card = slip.elements.card;
        
        // Remove existing status classes
        card.classList.remove('processing', 'completed', 'error');
        badge.classList.remove('processing', 'completed', 'error', 'skipped');
        
        switch (status) {
          case 'processing':
            badge.textContent = "กำลังสแกน...";
            badge.classList.add('processing');
            card.classList.add('processing');
            break;
          case 'completed':
            badge.textContent = "สำเร็จ";
            badge.classList.add('completed');
            card.classList.add('completed');
            break;
          case 'error':
            badge.textContent = message || "เกิดข้อผิดพลาด";
            badge.classList.add('error');
            card.classList.add('error');
            break;
          case 'skipped':
            badge.textContent = message || "ข้าม";
            badge.classList.add('skipped');
            break;
        }
      }

      function redrawCanvasWithRect(slip) {
        const { canvas, ctx, selRect, selRectName, img, elements } = slip;
        
        try {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          
          const ovCtx = elements.overlayContainer.getContext("2d");
          ovCtx.clearRect(0, 0, elements.overlayContainer.width, elements.overlayContainer.height);
          
          if (selRect) {
            drawOverlayRect(ovCtx, selRect, "red");
          }
          if (selRectName) {
            drawOverlayRect(ovCtx, selRectName, "blue");
          }
        } catch (err) {
          console.error("Error redrawing canvas:", err);
        }
      }

      function drawOverlayRect(ctx, rect, color = "red") {
        if (!rect || !ctx) return;
        
        try {
          ctx.fillStyle = "rgba(0,0,0,0.25)";
          ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
          ctx.clearRect(rect.x, rect.y, rect.w, rect.h);
          ctx.strokeStyle = color;
          ctx.lineWidth = Math.max(2, Math.round(Math.min(ctx.canvas.width, ctx.canvas.height) / 300));
          ctx.strokeRect(rect.x + 0.5, rect.y + 0.5, rect.w, rect.h);
        } catch (err) {
          console.error("Error drawing overlay rect:", err);
        }
      }

      async function processSlipOCR(slip) {
        if (!slip.selRect && !slip.selRectName) {
          throw new Error("ยังไม่ได้เลือกกรอบสำหรับสแกน");
        }

        setSlipStatus(slip, 'processing');

        try {
          // OCR ตัวเลข
          if (slip.selRect) {
            const cNum = document.createElement("canvas");
            cNum.width = slip.selRect.w;
            cNum.height = slip.selRect.h;
            const cx = cNum.getContext("2d");
            
            cx.drawImage(
              slip.canvas,
              slip.selRect.x, slip.selRect.y, slip.selRect.w, slip.selRect.h,
              0, 0, cNum.width, cNum.height
            );

            slip.elements.ocrTextElem.textContent = "กำลังอ่านตัวเลข...";

            const result = await Tesseract.recognize(cNum, "eng+tha", {
              logger: m => {
                if (m.status === 'recognizing text') {
                  const progress = Math.round(m.progress * 100);
                  slip.elements.ocrTextElem.textContent = `กำลังอ่าน... ${progress}%`;
                }
              }
            });

            slip.ocrText = result.data.text.trim();

            const nums = (slip.ocrText.match(/[\d,.]+(?:\.\d+)?/g) || [])
              .map(s => parseFloat(s.replace(/,/g, "")))
              .filter(v => isFinite(v) && v > 0);

            if (nums.length) {
              slip.number = Math.max(...nums);
            } else {
              slip.number = null;
            }
          }

          // OCR ชื่อผู้โอน
          if (slip.selRectName) {
            const cName = document.createElement("canvas");
            cName.width = slip.selRectName.w;
            cName.height = slip.selRectName.h;
            const cx = cName.getContext("2d");
            
            cx.drawImage(
              slip.canvas,
              slip.selRectName.x, slip.selRectName.y, slip.selRectName.w, slip.selRectName.h,
              0, 0, cName.width, cName.height
            );

            slip.elements.ocrNameElem.textContent = "กำลังอ่านชื่อ...";

            const result = await Tesseract.recognize(cName, "eng+tha");
            slip.ocrName = result.data.text.replace(/\n/g, " ").trim();
            slip.elements.ocrNameElem.textContent = slip.ocrName || "-";
          }

          // แสดงผลลัพธ์
          slip.elements.ocrTextElem.textContent = slip.ocrText + 
            (slip.number != null ? ` → ตัวเลข: ${slip.number.toFixed(2)}` : " → ไม่พบตัวเลข");
          slip.elements.ocrTextElem.style.color = slip.number ? "green" : "orange";

          setSlipStatus(slip, 'completed');

        } catch (err) {
          console.error("OCR Error:", err);
          slip.elements.ocrTextElem.textContent = `Error: ${err.message}`;
          slip.elements.ocrTextElem.style.color = "red";
          setSlipStatus(slip, 'error', err.message);
          throw err;
        }
      }

      // Enhanced parallel scanning with cancellation support
      btnScanAll.addEventListener("click", async () => {
        const bank = document.getElementById("bankSelect").value;
        if (!bank) {
          showError("กรุณาเลือกธนาคารก่อนสแกน");
          return;
        }
        if (!slips.length) {
          showError("ยังไม่มีรูปสลิป");
          return;
        }

        if (isScanning) return;
        
        try {
          isScanning = true;
          scanController = new AbortController();
          
          btnScanAll.disabled = true;
          btnStopScan.style.display = "inline-block";
          showProgress();

          // ตรวจสอบการซ้ำ
          updateProgress(0, 1, "ตรวจสอบรูปซ้ำ");
          const duplicateCount = await checkDuplicates(slips);
          if (duplicateCount > 0) {
            showError(`พบสลิปซ้ำ ${duplicateCount} ใบ จะข้ามการสแกน`);
          }

          // กำหนดพิกัดตามธนาคาร
          const pendingSlips = slips.filter(s => !s.isDuplicate);
          await setupBankCoordinates(bank, pendingSlips);

          // สแกนแบบ parallel (ทีละ 3 ใบ)
          updateProgress(0, pendingSlips.length, "เริ่มสแกน");
          
          const batchSize = 3;
          let completed = 0;
          let errors = 0;

          for (let i = 0; i < pendingSlips.length; i += batchSize) {
            if (scanController.signal.aborted) {
              showError("ยกเลิกการสแกนแล้ว");
              break;
            }

            const batch = pendingSlips.slice(i, i + batchSize);
            const promises = batch.map(async (slip) => {
              try {
                await processSlipOCR(slip);
                completed++;
                updateProgress(completed, pendingSlips.length, `สแกนสำเร็จ: ${slip.file.name}`);
              } catch (err) {
                errors++;
                console.error(`Error processing ${slip.file.name}:`, err);
                setSlipStatus(slip, 'error', 'OCR ล้มเหลว');
                updateProgress(completed, pendingSlips.length, `Error: ${slip.file.name}`);
              }
            });

            await Promise.allSettled(promises);
            
            // พักระหว่าง batch
            if (i + batchSize < pendingSlips.length) {
              await new Promise(resolve => setTimeout(resolve, 500));
            }
          }

          const successCount = completed;
          const skippedCount = duplicateCount;
          
          if (errors === 0 && successCount > 0) {
            showSuccess(`สแกนสำเร็จทั้งหมด ${successCount} ใบ${skippedCount > 0 ? ` (ข้ามรูปซ้ำ ${skippedCount} ใบ)` : ''}`);
          } else if (successCount > 0) {
            showError(`สแกนสำเร็จ ${successCount} ใบ, ล้มเหลว ${errors} ใบ`);
          } else {
            showError("ไม่สามารถสแกนได้เลย");
          }

          refreshSummary();

        } catch (err) {
          showError(`Error: ${err.message}`);
        } finally {
          isScanning = false;
          scanController = null;
          btnScanAll.disabled = false;
          btnStopScan.style.display = "none";
          hideProgress();
        }
      });

      btnStopScan.addEventListener("click", () => {
        if (scanController) {
          scanController.abort();
          showError("กำลังหยุดการสแกน...");
        }
      });

      async function setupBankCoordinates(bank, slips) {
        const inputRx = document.getElementById("inputRx");
        const inputRy = document.getElementById("inputRy");
        const inputRw = document.getElementById("inputRw");
        const inputRh = document.getElementById("inputRh");
        const inputRxName = document.getElementById("inputRxName");
        const inputRyName = document.getElementById("inputRyName");
        const inputRwName = document.getElementById("inputRwName");
        const inputRhName = document.getElementById("inputRhName");

        for (const s of slips) {
          if (bank === "Bangkok") {
            // Bangkok bank specific coordinates based on image size
            if (s.canvas.width === 622 && s.canvas.height === 1280) {
              s.selRect = {
                x: Math.round(0.21 * s.canvas.width),
                y: Math.round(0.32 * s.canvas.height),
                w: Math.round(0.4 * s.canvas.width),
                h: Math.round(0.06 * s.canvas.height),
              };
              s.selRectName = {
                x: Math.round(0.42 * s.canvas.width),
                y: Math.round(0.43 * s.canvas.height),
                w: Math.round(0.45 * s.canvas.width),
                h: Math.round(0.04 * s.canvas.height),
              };
            } else if (s.canvas.width === 522 && s.canvas.height === 1280) {
              s.selRect = {
                x: Math.round(0.12 * s.canvas.width),
                y: Math.round(0.41 * s.canvas.height),
                w: Math.round(0.5 * s.canvas.width),
                h: Math.round(0.06 * s.canvas.height),
              };
              s.selRectName = {
                x: Math.round(0.42 * s.canvas.width),
                y: Math.round(0.52 * s.canvas.height),
                w: Math.round(0.45 * s.canvas.width),
                h: Math.round(0.04 * s.canvas.height),
              };
            } else {
              // Default Bangkok coordinates
              s.selRect = {
                x: Math.round(0.21 * s.canvas.width),
                y: Math.round(0.32 * s.canvas.height),
                w: Math.round(0.4 * s.canvas.width),
                h: Math.round(0.06 * s.canvas.height),
              };
              s.selRectName = {
                x: Math.round(0.42 * s.canvas.width),
                y: Math.round(0.43 * s.canvas.height),
                w: Math.round(0.45 * s.canvas.width),
                h: Math.round(0.04 * s.canvas.height),
              };
            }
          } else {
            // Use manual coordinates for other banks
            if (!s.selRect) {
              s.selRect = {
                x: Math.round(parseFloat(inputRx.value) * s.canvas.width),
                y: Math.round(parseFloat(inputRy.value) * s.canvas.height),
                w: Math.round(parseFloat(inputRw.value) * s.canvas.width),
                h: Math.round(parseFloat(inputRh.value) * s.canvas.height),
              };
            }
            if (!s.selRectName) {
              s.selRectName = {
                x: Math.round(parseFloat(inputRxName.value) * s.canvas.width),
                y: Math.round(parseFloat(inputRyName.value) * s.canvas.height),
                w: Math.round(parseFloat(inputRwName.value) * s.canvas.width),
                h: Math.round(parseFloat(inputRhName.value) * s.canvas.height),
              };
            }
          }

          redrawCanvasWithRect(s);
          s.elements.rectInfo.textContent = `(แนะนำ) x:${s.selRect.x} y:${s.selRect.y} w:${s.selRect.w} h:${s.selRect.h}`;
        }
      }

      btnClear.addEventListener("click", () => {
        if (isScanning && scanController) {
          scanController.abort();
        }
        
        slips = [];
        cards.innerHTML = "";
        input.value = "";
        document.getElementById("resultsPanel").style.display = "none";
        hideProgress();
        errorMessage.style.display = "none";
        successMessage.style.display = "none";
        document.getElementById("status").textContent = "อัปโหลดรูปสลิปหลายไฟล์ แล้วลากกรอบสีบนรูปเพื่อเลือกพื้นที่ OCR";
      });

      function refreshSummary() {
        const resultsPanel = document.getElementById("resultsPanel");
        const totalCountElem = document.getElementById("totalCount");
        const grandTotalElem = document.getElementById("grandTotal");
        const perSlipList = document.getElementById("perSlipList");

        const count = slips.length;
        totalCountElem.textContent = count;
        let grand = 0.0;
        perSlipList.innerHTML = "";

        slips.forEach((s, idx) => {
          const val = s.number != null && !isNaN(s.number) ? s.number : null;
          if (val != null) grand += val;

          const row = document.createElement("div");
          row.className = "row";

          const left = document.createElement("div");
          left.innerHTML = `
            <strong>ใบ ${idx + 1}</strong>
            <div class="small">${s.file.name}</div>
          `;

          const right = document.createElement("div");
          right.style.textAlign = "right";
          right.innerHTML = `
            <div class="small">OCR: ${s.ocrText ? s.ocrText.replace(/\n/g, " / ") : "-"}</div>
            <div class="small">ชื่อผู้โอน: ${s.ocrName ? s.ocrName.replace(/\s+/g, '').replace(/(\p{L}+)(\p{L}+)/u, '$1 $2') : "-"}</div>
            <div style="font-weight:700; margin-top:6px;">฿ ${val != null ? Number(val).toFixed(2) : "-"}</div>
          `;

          row.appendChild(left);
          row.appendChild(right);
          perSlipList.appendChild(row);
        });

        grandTotalElem.textContent = grand.toFixed(2);
        resultsPanel.style.display = "block";
      }

      // Bank selection handler
      document.getElementById("bankSelect").addEventListener("change", (e) => {
        const bank = e.target.value;
        const inputRx = document.getElementById("inputRx");
        const inputRy = document.getElementById("inputRy");
        const inputRw = document.getElementById("inputRw");
        const inputRh = document.getElementById("inputRh");
        const inputRxName = document.getElementById("inputRxName");
        const inputRyName = document.getElementById("inputRyName");
        const inputRwName = document.getElementById("inputRwName");
        const inputRhName = document.getElementById("inputRhName");

        function setValues(number, name) {
          inputRx.value = number.rx;
          inputRy.value = number.ry;
          inputRw.value = number.rw;
          inputRh.value = number.rh;
          inputRxName.value = name.rx;
          inputRyName.value = name.ry;
          inputRwName.value = name.rw;
          inputRhName.value = name.rh;
        }

        const bankCoordinates = {
          SCB: {
            number: { rx: 0.518, ry: 0.599, rw: 0.456, rh: 0.075 },
            name: { rx: 0.54, ry: 0.32, rw: 0.45, rh: 0.08 },
          },
          Krungthai: {
            number: { rx: 0.55, ry: 0.75, rw: 0.35, rh: 0.07 },
            name: { rx: 0.15, ry: 0.36, rw: 0.45, rh: 0.06 },
          },
          TTB: {
            number: { rx: 0.21, ry: 0.35, rw: 0.4, rh: 0.06 },
            name: { rx: 0.18, ry: 0.46, rw: 0.45, rh: 0.04 },
          },
          KPLUS: {
            number: { rx: 0.36, ry: 0.78, rw: 0.3, rh: 0.06 },
            name: { rx: 0.2, ry: 0.16, rw: 0.4, rh: 0.08 },
          },
        };

        if (bank === "Bangkok") {
          if (slips.length > 0) {
            const w = slips[0].canvas.width;
            const h = slips[0].canvas.height;
            if (w === 622 && h === 1280) {
              setValues(
                { rx: 0.21, ry: 0.32, rw: 0.4, rh: 0.06 },
                { rx: 0.42, ry: 0.43, rw: 0.45, rh: 0.04 }
              );
            } else if (w === 522 && h === 1280) {
              setValues(
                { rx: 0.12, ry: 0.41, rw: 0.5, rh: 0.06 },
                { rx: 0.42, ry: 0.52, rw: 0.45, rh: 0.04 }
              );
            } else {
              setValues(
                { rx: 0.21, ry: 0.32, rw: 0.4, rh: 0.06 },
                { rx: 0.42, ry: 0.43, rw: 0.45, rh: 0.04 }
              );
            }
          }
        } else if (bankCoordinates[bank]) {
          setValues(bankCoordinates[bank].number, bankCoordinates[bank].name);
        }
      });

      // Drag functionality
      const toggleDragBtn = document.getElementById("toggleDrag");
      toggleDragBtn.textContent = dragEnabled ? "ปิดการกำหนดตำแหน่ง" : "เปิดการกำหนดตำแหน่ง";

      toggleDragBtn.addEventListener("click", () => {
        dragEnabled = !dragEnabled;
        toggleDragBtn.textContent = dragEnabled ? "ปิดการกำหนดตำแหน่ง" : "เปิดการกำหนดตำแหน่ง";
      });

      function enableRectSelection(wrapper, canvas, slip) {
        const overlayCanvas = document.createElement("canvas");
        overlayCanvas.style.position = "absolute";
        overlayCanvas.style.left = "0";
        overlayCanvas.style.top = "0";
        overlayCanvas.style.width = "100%";
        overlayCanvas.style.height = "100%";
        overlayCanvas.width = canvas.width;
        overlayCanvas.height = canvas.height;
        overlayCanvas.style.pointerEvents = "auto";
        overlayCanvas.style.zIndex = "1000";

        slip.overlayCanvas = overlayCanvas;
        wrapper.appendChild(overlayCanvas);

        let dragging = false, startX = 0, startY = 0;

        function clientToCanvasCoords(evt) {
          const rect = overlayCanvas.getBoundingClientRect();
          const scaleX = overlayCanvas.width / rect.width;
          const scaleY = overlayCanvas.height / rect.height;
          return {
            x: Math.max(0, Math.min(overlayCanvas.width, (evt.clientX - rect.left) * scaleX)),
            y: Math.max(0, Math.min(overlayCanvas.height, (evt.clientY - rect.top) * scaleY)),
          };
        }

        overlayCanvas.addEventListener("pointerdown", (e) => {
          if (!dragEnabled) return;
          e.preventDefault();
          dragging = true;
          const p = clientToCanvasCoords(e);
          startX = p.x;
          startY = p.y;
        });

        overlayCanvas.addEventListener("pointermove", (e) => {
          if (!dragEnabled || !dragging) return;
          const p = clientToCanvasCoords(e);
          const x = Math.min(startX, p.x);
          const y = Math.min(startY, p.y);
          const w = Math.abs(p.x - startX);
          const h = Math.abs(p.y - startY);
          
          slip.selRect = { x: Math.round(x), y: Math.round(y), w: Math.round(w), h: Math.round(h) };
          
          const ctx = overlayCanvas.getContext("2d");
          ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
          drawOverlayRect(ctx, slip.selRect, "red");
          
          slip.elements.rectInfo.textContent = `x:${slip.selRect.x} y:${slip.selRect.y} w:${slip.selRect.w} h:${slip.selRect.h}`;
        });

        window.addEventListener("pointerup", () => {
          if (!dragEnabled || !dragging) return;
          dragging = false;
          redrawCanvasWithRect(slip);
        });
      }

      // Duplicate detection
      async function computeImageHash(canvas) {
        try {
          const blob = await new Promise((resolve, reject) => {
            canvas.toBlob(resolve, 'image/jpeg', 0.8);
            setTimeout(() => reject(new Error('Timeout creating blob')), 5000);
          });
          const arrayBuffer = await blob.arrayBuffer();
          const hashBuffer = await crypto.subtle.digest("SHA-256", arrayBuffer);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
        } catch (err) {
          console.error("Error computing hash:", err);
          return Math.random().toString(36); // Fallback to prevent false duplicates
        }
      }

      async function checkDuplicates(slips) {
        const hashes = new Set();
        let duplicateCount = 0;
        
        for (const slip of slips) {
          try {
            const hash = await computeImageHash(slip.canvas);
            slip.hash = hash;
            
            if (hashes.has(hash)) {
              slip.isDuplicate = true;
              duplicateCount++;
              setSlipStatus(slip, 'skipped', 'รูปซ้ำ');
              slip.elements.ocrTextElem.textContent = "รูปสลิปซ้ำ! จะไม่ OCR";
              slip.elements.ocrTextElem.style.color = "red";
              slip.elements.btnOCR.disabled = true;
              slip.elements.btnEditNumber.disabled = true;
            } else {
              slip.isDuplicate = false;
              hashes.add(hash);
              slip.elements.ocrTextElem.style.color = "";
              slip.elements.btnOCR.disabled = false;
              slip.elements.btnEditNumber.disabled = false;
            }
          } catch (err) {
            console.error(`Error checking duplicate for ${slip.file.name}:`, err);
            slip.isDuplicate = false; // Assume not duplicate on error
          }
        }
        
        return duplicateCount;
      }
      
    </script>
  </body>
</html>